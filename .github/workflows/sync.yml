name: Sync Open WebUI Image & Update Readme

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 2 * * *' # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ 10:00 (UTC 2:00)

jobs:
  sync-and-update:
    runs-on: ubuntu-latest
    #ä»¥æ­¤æƒé™é…ç½®ï¼Œå…è®¸ Action ä¿®æ”¹ä»“åº“ä»£ç å’Œä¸Šä¼ åŒ…
    permissions:
      contents: write  # å…è®¸å†™å…¥ä»£ç  (ä¿®æ”¹ README)
      packages: write  # å…è®¸å†™å…¥åŒ… (æ¨é•œåƒ)

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Sync Multi-Arch Image
        id: sync
        run: |
          # å®šä¹‰é•œåƒå˜é‡
          SOURCE="docker://ghcr.io/open-webui/open-webui:main"
          TARGET="docker://ghcr.io/${{ github.repository_owner }}/ai-open:latest"
          
          echo "Source: $SOURCE"
          echo "Target: $TARGET"

          # ä½¿ç”¨ skopeo åŒæ­¥
          skopeo copy \
            --all \
            --src-no-creds \
            --dest-creds "${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}" \
            $SOURCE $TARGET
          
          echo "status=success" >> $GITHUB_OUTPUT

      - name: Update README with Status
        # å³ä½¿åŒæ­¥å¤±è´¥ï¼Œè¿™ä¸€æ­¥ä¹Ÿå¯ä»¥è¿è¡Œï¼ˆå¯é€‰ï¼‰ï¼Œè¿™é‡Œé»˜è®¤åªåœ¨æˆåŠŸåè¿è¡Œ
        if: steps.sync.outputs.status == 'success'
        run: |
          # 1. è®¾ç½®æ—¶åŒºä¸ºåŒ—äº¬æ—¶é—´
          export TZ='Asia/Shanghai'
          DATE=$(date '+%Y-%m-%d %H:%M:%S')
          
          # 2. ç”Ÿæˆ README å†…å®¹ (è¿™é‡Œæ˜¯å®Œå…¨è¦†ç›–å†™å…¥)
          # ä½ å¯ä»¥åœ¨ä¸‹é¢è‡ªå®šä¹‰ä½ æƒ³æ˜¾ç¤ºçš„ä»»ä½• Markdown å†…å®¹
          cat > README.md <<EOF
          # AI Open WebUI Mirror
          
          è¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨åŒæ­¥çš„é•œåƒä»“åº“ï¼Œæºè‡ª [open-webui/open-webui](https://github.com/open-webui/open-webui)ã€‚
          
          è¯¥ä»“åº“æ¯å¤©è‡ªåŠ¨æ‹‰å–å®˜æ–¹æœ€æ–° \`main\` åˆ†æ”¯é•œåƒï¼Œå¹¶æ”¯æŒå…¨æ¶æ„ï¼ˆAMD64/ARM64ï¼‰ã€‚
          
          ### ğŸš€ å¿«é€Ÿä½¿ç”¨
          
          \`\`\`bash
          docker run -d -p 3000:8080 \\
            --add-host=host.docker.internal:host-gateway \\
            -v open-webui:/app/backend/data \\
            --name open-webui \\
            --restart always \\
            ghcr.io/${{ github.repository_owner }}/ai-open:latest
          \`\`\`
          
          ### ğŸ“Š åŒæ­¥çŠ¶æ€
          
          - **æºé•œåƒ**: \`ghcr.io/open-webui/open-webui:main\`
          - **ä¸Šæ¬¡åŒæ­¥æ—¶é—´ (åŒ—äº¬æ—¶é—´)**: \`$DATE\`
          - **åŒæ­¥çŠ¶æ€**: âœ… æˆåŠŸ
          - **æ¶æ„æ”¯æŒ**: \`linux/amd64\`, \`linux/arm64\` ç­‰
          
          > æ­¤æ–‡ä»¶ç”± GitHub Actions æ¯æ—¥è‡ªåŠ¨ç”Ÿæˆï¼Œä»¥ä¿æŒä»“åº“æ´»è·ƒã€‚
          EOF

      - name: Commit and Push changes
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          # æ·»åŠ  README.md
          git add README.md
          
          # æäº¤æ›´æ”¹ (å¦‚æœå†…å®¹æ²¡å˜ï¼Œè¿™æ­¥ä¸ä¼šæŠ¥é”™)
          git commit -m "Auto update README: $(date '+%Y-%m-%d')" || echo "No changes to commit"
          
          # æ¨é€åˆ°ä»“åº“
          git push
