name: Sync Open WebUI Image

on:
  workflow_dispatch: # 允许手动触发
  schedule:
    - cron: '0 2 * * *' # 每天北京时间上午 10:00 自动执行

jobs:
  sync-image:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Sync Multi-Arch Image using Skopeo
        run: |
          # 1. 定义源镜像和目标镜像
          SOURCE_IMAGE="docker://ghcr.io/open-webui/open-webui:main"
          TARGET_IMAGE="docker://ghcr.io/datallmfour/ai-open:latest"

          echo "开始同步镜像..."
          echo "源: $SOURCE_IMAGE"
          echo "目标: $TARGET_IMAGE"

          # 2. 使用 skopeo 直接进行全量同步
          # --all 表示同步所有 CPU 架构 (amd64, arm64, etc.)
          # --dest-creds 使用当前运行者的身份进行认证
          skopeo copy \
            --all \
            --src-no-creds \
            --dest-creds "${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}" \
            $SOURCE_IMAGE $TARGET_IMAGE

          echo "同步成功！"
